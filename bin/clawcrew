#!/usr/bin/env node

/**
 * ClawCrew CLI - OpenClaw with personality
 */

const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');
const readline = require('readline');

const CLAWCREW_DIR = path.join(process.env.HOME, '.clawcrew');
const CONFIG_PATH = path.join(CLAWCREW_DIR, 'config.json');
const CREW_PATH = path.join(CLAWCREW_DIR, 'crew.json');

// Colors
const c = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  dim: '\x1b[2m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

const log = {
  info: (msg) => console.log(`${c.blue}‚Ñπ${c.reset} ${msg}`),
  success: (msg) => console.log(`${c.green}‚úì${c.reset} ${msg}`),
  warn: (msg) => console.log(`${c.yellow}‚ö†${c.reset} ${msg}`),
  error: (msg) => console.log(`${c.red}‚úó${c.reset} ${msg}`),
  gambit: (msg) => console.log(`${c.magenta}üÉè${c.reset} ${msg}`),
};

// Crew templates
const crewTemplates = {
  'xmen': {
    name: 'X-Men Crew',
    description: 'Gambit (coord) + Beast (research) + Wolverine (build) + Magneto (QA)',
    agents: [
      { id: 'gambit', name: 'Gambit', emoji: 'üÉè', role: 'coordinator' },
      { id: 'beast', name: 'Beast', emoji: 'üî¨', role: 'researcher' },
      { id: 'wolverine', name: 'Wolverine', emoji: 'üê∫', role: 'engineer' },
      { id: 'magneto', name: 'Magneto', emoji: 'üß≤', role: 'qa' },
    ],
  },
  'startup': {
    name: 'Startup Crew',
    description: 'Coordinator + Engineer + Researcher + Creative',
    agents: [
      { id: 'coordinator', name: 'The Boss', emoji: 'üéØ', role: 'coordinator' },
      { id: 'engineer', name: 'The Builder', emoji: '‚öôÔ∏è', role: 'engineer' },
      { id: 'researcher', name: 'The Brain', emoji: 'üîç', role: 'researcher' },
      { id: 'creative', name: 'The Artist', emoji: 'üé®', role: 'creative' },
    ],
  },
  'solo': {
    name: 'Solo Crew',
    description: 'Just you and Gambit',
    agents: [
      { id: 'gambit', name: 'Gambit', emoji: 'üÉè', role: 'coordinator' },
    ],
  },
};

function ensureDir() {
  if (!fs.existsSync(CLAWCREW_DIR)) {
    fs.mkdirSync(CLAWCREW_DIR, { recursive: true });
  }
}

function loadConfig() {
  if (fs.existsSync(CONFIG_PATH)) {
    return JSON.parse(fs.readFileSync(CONFIG_PATH, 'utf-8'));
  }
  return null;
}

function saveConfig(config) {
  ensureDir();
  fs.writeFileSync(CONFIG_PATH, JSON.stringify(config, null, 2));
}

function loadCrew() {
  if (fs.existsSync(CREW_PATH)) {
    return JSON.parse(fs.readFileSync(CREW_PATH, 'utf-8'));
  }
  return null;
}

function saveCrew(crew) {
  ensureDir();
  fs.writeFileSync(CREW_PATH, JSON.stringify(crew, null, 2));
}

// Simple sync prompt
function prompt(question) {
  return new Promise((resolve) => {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
      terminal: process.stdin.isTTY,
    });
    
    rl.question(question, (answer) => {
      rl.close();
      resolve(answer ? answer.trim() : '');
    });
    
    // Handle non-TTY (piped input)
    if (!process.stdin.isTTY) {
      rl.once('close', () => resolve(''));
    }
  });
}

// --- Commands ---

async function init() {
  console.log(`
${c.bright}${c.magenta}
   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
  ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïî‚ïù
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù
${c.reset}
  ${c.dim}OpenClaw with personality${c.reset}
  `);

  log.gambit("Bonjour, mon ami! Let's set up your crew.");
  console.log('');

  // Check TTY
  if (!process.stdin.isTTY) {
    log.warn('Non-interactive mode detected. Using defaults (X-Men crew).');
    const template = crewTemplates['xmen'];
    
    const config = {
      template: 'xmen',
      apiKey: null,
      createdAt: new Date().toISOString(),
    };
    saveConfig(config);
    
    const crew = {
      id: 'xmen',
      name: template.name,
      agents: template.agents,
      coordinatorId: template.agents[0].id,
      createdAt: new Date().toISOString(),
    };
    saveCrew(crew);
    
    log.success('ClawCrew initialized with X-Men crew!');
    log.info(`Config: ${CONFIG_PATH}`);
    log.gambit("Run 'clawcrew status' to see your crew.");
    return;
  }

  // Interactive mode
  const existing = loadConfig();
  if (existing) {
    const overwrite = await prompt(`${c.yellow}Existing config found. Overwrite? (y/N): ${c.reset}`);
    if (overwrite.toLowerCase() !== 'y') {
      log.info('Keeping existing config.');
      return;
    }
  }

  console.log(`\n${c.bright}Choose your crew:${c.reset}\n`);
  const templateIds = Object.keys(crewTemplates);
  templateIds.forEach((id, i) => {
    const t = crewTemplates[id];
    console.log(`  ${c.cyan}${i + 1}.${c.reset} ${t.name}`);
    console.log(`     ${c.dim}${t.description}${c.reset}`);
    console.log(`     ${t.agents.map(a => a.emoji).join(' ')}`);
    console.log('');
  });

  const choice = await prompt(`${c.cyan}Enter choice (1-${templateIds.length}) [1]: ${c.reset}`);
  const templateId = templateIds[parseInt(choice) - 1] || 'xmen';
  const template = crewTemplates[templateId];

  log.success(`Selected: ${template.name}`);

  console.log('');
  const apiKey = await prompt(`${c.cyan}Anthropic API Key (Enter to skip): ${c.reset}`);

  const config = {
    template: templateId,
    apiKey: apiKey || null,
    createdAt: new Date().toISOString(),
  };
  saveConfig(config);

  const crew = {
    id: templateId,
    name: template.name,
    agents: template.agents,
    coordinatorId: template.agents[0].id,
    createdAt: new Date().toISOString(),
  };
  saveCrew(crew);

  console.log('');
  log.success('ClawCrew initialized!');
  log.info(`Config: ${CONFIG_PATH}`);
  log.info(`Crew: ${CREW_PATH}`);
  console.log('');
  log.gambit("Your crew is ready, cher. Run 'clawcrew status' to see them.");
}

function status() {
  const crew = loadCrew();
  if (!crew) {
    log.error("No crew found. Run 'clawcrew init' first.");
    return;
  }

  console.log(`
${c.bright}${c.magenta}üÉè ClawCrew Status${c.reset}
${c.dim}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${c.reset}

${c.bright}Crew:${c.reset} ${crew.name}
${c.bright}Created:${c.reset} ${new Date(crew.createdAt).toLocaleDateString()}

${c.bright}Agents:${c.reset}
`);

  crew.agents.forEach((agent) => {
    const isCoord = agent.id === crew.coordinatorId;
    console.log(`  ${agent.emoji} ${c.bright}${agent.name}${c.reset}${isCoord ? ` ${c.yellow}(coordinator)${c.reset}` : ''}`);
    console.log(`     ${c.dim}Role: ${agent.role}${c.reset}`);
  });

  console.log('');
}

function dashboard() {
  // Try multiple locations
  const locations = [
    path.join(__dirname, '..', 'skills', 'mission-control'),
    path.join(process.env.HOME, '.openclaw', 'clawcrew', 'skills', 'mission-control'),
    path.join(process.env.HOME, 'clawd', 'clawcrew', 'skills', 'mission-control'),
  ];
  
  let missionControlPath = null;
  for (const loc of locations) {
    if (fs.existsSync(path.join(loc, 'package.json'))) {
      missionControlPath = loc;
      break;
    }
  }
  
  if (!missionControlPath) {
    log.error('Mission Control not found. Run install.sh first.');
    return;
  }

  // Check if node_modules exists
  if (!fs.existsSync(path.join(missionControlPath, 'node_modules'))) {
    log.info('Installing Mission Control dependencies...');
    const { execSync } = require('child_process');
    try {
      execSync('npm install', { cwd: missionControlPath, stdio: 'inherit' });
    } catch (e) {
      log.error('Failed to install dependencies');
      return;
    }
  }

  log.info('Starting Mission Control...');
  
  const child = spawn('npm', ['run', 'dev'], {
    cwd: missionControlPath,
    stdio: 'inherit',
  });

  child.on('error', (err) => {
    log.error(`Failed to start: ${err.message}`);
  });
}

function run() {
  const crew = loadCrew();
  if (!crew) {
    log.error("No crew found. Run 'clawcrew init' first.");
    return;
  }

  log.gambit(`Starting ${crew.name}...`);
  
  // Check if openclaw is available
  const { execSync } = require('child_process');
  try {
    execSync('which openclaw', { stdio: 'pipe' });
  } catch {
    log.error('OpenClaw not found. Install it from https://openclaw.ai');
    return;
  }

  log.info('Launching OpenClaw with your crew...');
  
  const child = spawn('openclaw', [], {
    stdio: 'inherit',
    env: {
      ...process.env,
      CLAWCREW_ACTIVE: '1',
      CLAWCREW_TEMPLATE: crew.id,
    },
  });

  child.on('error', (err) => {
    log.error(`Failed to start: ${err.message}`);
  });
}

function list() {
  console.log(`\n${c.bright}Available Crew Templates:${c.reset}\n`);
  
  Object.entries(crewTemplates).forEach(([id, t]) => {
    console.log(`  ${c.cyan}${id}${c.reset}`);
    console.log(`  ${t.name}`);
    console.log(`  ${c.dim}${t.description}${c.reset}`);
    console.log(`  ${t.agents.map(a => `${a.emoji} ${a.name}`).join(', ')}`);
    console.log('');
  });
}

function help() {
  console.log(`
${c.bright}${c.magenta}üÉè ClawCrew${c.reset} - OpenClaw with personality

${c.bright}Usage:${c.reset}
  clawcrew <command>

${c.bright}Commands:${c.reset}
  init        Initialize a new crew (interactive wizard)
  status      Show your crew's status
  list        List available crew templates
  dashboard   Open Mission Control dashboard
  run         Start OpenClaw with your crew
  help        Show this help

${c.bright}Examples:${c.reset}
  clawcrew init          # Set up your crew
  clawcrew status        # See your agents
  clawcrew dashboard     # Open Mission Control
  clawcrew run           # Start OpenClaw

${c.dim}Laissez les bons temps rouler. üÉè${c.reset}
`);
}

// --- Main ---

const command = process.argv[2];

switch (command) {
  case 'init':
    init().catch(console.error);
    break;
  case 'status':
    status();
    break;
  case 'list':
    list();
    break;
  case 'dashboard':
    dashboard();
    break;
  case 'run':
    run();
    break;
  case 'help':
  case '--help':
  case '-h':
  case undefined:
    help();
    break;
  default:
    log.error(`Unknown command: ${command}`);
    help();
    process.exit(1);
}
